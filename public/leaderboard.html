<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Leaderboard | RoR Planner</title>
  <style>
    :root { color-scheme: light dark; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji"; margin: 0; padding: 2rem; line-height: 1.4; }
    .container { max-width: 1100px; margin: 0 auto; }
    h1 { margin: 0 0 1rem; font-size: 1.6rem; }
  /* Layout refinements */
  .top-bar { display:none; }
  .table-title { text-align:center; font-size:1.35rem; font-weight:600; margin:0 0 .75rem; color:#f8f9fa; }
  .period-center { display:none; }
  .period-title { font-size:1.1rem; font-weight:600; text-align:center; }
  .period-selector { display:flex; align-items:center; justify-content:center; gap:.6rem; position:relative; }
  .group-row th { color:#f8f9fa; padding:.4rem .7rem; }
  .group-row th:not(.lifetime-group) { background:#181d22; }
  .group-row th.lifetime-group { background:#202b33; }
  .group-row .lifetime-title { font-size:.9rem; font-weight:600; text-align:center; opacity:.85; }
  .group-row .period-title { font-size:1rem; }
  .nav-arrow { padding:.4rem .7rem; font-size:.9rem; border-radius:.5rem; border:1px solid #5558; background:#374151; color:#fff; cursor:pointer; }
  .nav-arrow:disabled { opacity:.5; cursor:default; }
  .mode-btn { padding:.45rem .8rem; font-size:.9rem; border-radius:.5rem; border:1px solid #5558; background:#374151; color:#fff; cursor:pointer; }
  .mode-btn.active { background:#2563eb; }
  .footer-bar { display:grid; grid-template-columns:1fr auto 1fr; align-items:center; gap:.75rem; margin-top:1rem; }
    input[type="number"], select { padding: .5rem .6rem; font-size: 1rem; border-radius: .5rem; border: 1px solid #9999; }
    button { padding: .6rem 1rem; font-size: 1rem; border-radius: .5rem; border: 1px solid #5558; background: #2563eb; color: white; cursor: pointer; }
    button:disabled { opacity: .6; cursor: default; }
    .muted { opacity: .8; font-size: .95rem; }
    .error { color: #b00020; margin: .5rem 0 0; }
    .controls { display: flex; gap: .5rem; flex-wrap: wrap; align-items: center; margin: .5rem 0 1rem; }
    table { width: 100%; border-collapse: collapse; border: 1px solid #9994; border-radius: .5rem; overflow: hidden; }
    thead { background: #f4f4f8; color: #111; }
    :root[data-theme="dark"] thead { background: #1f2937; color: #e5e7eb; }
  th, td { padding: .55rem .7rem; border-bottom: 1px solid #9993; font-variant-numeric: tabular-nums; }
  th { font-weight: 600; user-select: none; text-align: left; }
  td.num, th.num { text-align: right; }
  
  table { background:#0d0f11; }
  thead { background:transparent; color:#f8f9fa; }
  :root[data-theme="dark"] thead { background:transparent; color:#f8f9fa; }
  /* Column header shading */
  thead tr:nth-child(2) th:not(.lifetime) { background:#181d22; }
  thead tr:nth-child(2) th.lifetime { background:#202b33; }
  tfoot { background:transparent; }
  tfoot td { color:#f8f9fa; }
  tfoot td.period-footer { background:#181d22; }
  tfoot td.lifetime-footer { background:#202b33; }
  tbody tr { background:#121417; color:#f8f9fa; }
  tbody tr:nth-child(even) { background:#1a1d21; }
  
  th { color:#f8f9fa; }
  td { color:#f8f9fa; }
  
    .table-wrap { width:100%; }
    .table-body-wrap { overflow-y:auto; }
  
    .table-body-wrap { scrollbar-width: none; -ms-overflow-style: none; }
    .table-body-wrap::-webkit-scrollbar { width: 0; height: 0; display: none; }
  
    .tbl { width:100%; border-collapse: collapse; }
    .tbl.header { border-bottom: none; }
    .tbl.body { border-top: none; border-bottom: none; }
    .tbl.footer { border-top: none; }
  
    th.rank, td.rank { width: 42px; }
  /* Monospace font for row data for improved numeric alignment */
  tbody td { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Roboto Mono", "Courier New", monospace; }
  .career-icon { width:20px; height:20px; object-fit:contain; vertical-align:middle; border-radius:4px; background:#1c1f24; }
  .char-cell { display:flex; align-items:center; gap:6px; width:100%; }
  .char-meta { font-size:.75rem; margin-left:auto; text-align:right; white-space:nowrap; color:#d1d5db; }
  .char-meta .num-val { color:#f8f9fa; font-weight:500; }
  .current-btn { padding:.45rem .9rem; font-size:.85rem; border:1px solid #5558; background:#374151; color:#fff; border-radius:.5rem; cursor:pointer; }
  .current-btn.active { background:#2563eb; }
  .current-btn:disabled { opacity:.6; cursor:default; }
  
  .agg-control { display:none; align-items:center; gap:.4rem; font-size:.85rem; opacity:.95; position:absolute; right:0; top:50%; transform:translateY(-50%); }
  .agg-control label { opacity:.9; }
  #aggSelect { padding:.25rem .45rem; font-size:.85rem; border-radius:.35rem; border:1px solid #5558; background:#111827; color:#e5e7eb; }
  
  th.lifetime, td.lifetime { background:#1d2126; }
  tbody tr:nth-child(even) td.lifetime { background:#252b31; }
  td.lifetime, th.lifetime { color:#f0f2f4; }
  
  th.rank, td.rank { text-align:left; width:42px; }
  
  .sortable { cursor:pointer; }
  .sort-arrow { width:16px; height:16px; display:inline-block; vertical-align:middle; margin-left:.08rem; stroke:none; fill:#64748b; opacity:.45; transition:fill .15s, opacity .15s, transform .15s; transform: rotate(0deg); }
  
  .tbl.header thead tr:nth-child(2) th { white-space: nowrap; }
  .sortable.active.asc .sort-arrow { fill:#3b82f6; opacity:1; transform: rotate(0deg); }
  .sortable.active.desc .sort-arrow { fill:#3b82f6; opacity:1; transform: rotate(180deg); }
  .sortable:hover .sort-arrow { opacity:.75; }
    .chip { display: inline-block; font-size: .85rem; padding: .15rem .5rem; border-radius: 999px; border: 1px solid #9995; }
    .spacer { flex: 1; }
    .small { font-size: .9rem; }
    
    #status { font-size:.8rem; }
  </style>
</head>
<body>
  <div class="container">
  <h1 class="table-title">Leaderboard</h1>

    

    <div id="errorBox" class="error" style="display:none"></div>

    <div id="tableWrap" class="table-wrap">
      
      <table class="tbl header">
        <colgroup>
          <col style="width:42px;" />
          <col />
          <col style="width:96px;" />
          <col style="width:96px;" />
          <col style="width:96px;" />
          <col style="width:96px;" />
          <col style="width:96px;" />
          <col style="width:96px;" />
        </colgroup>
        <thead>
          <tr class="group-row">
            <th colspan="5">
              <div class="period-selector">
                <button id="periodPrevBtn" class="nav-arrow" title="Previous">◀</button>
                <div id="periodTitle" class="period-title">&nbsp;</div>
                <button id="periodNextBtn" class="nav-arrow" title="Next">▶</button>
                <div class="agg-control" id="aggControl">
                  <label for="aggSelect">Aggregate by</label>
                  <select id="aggSelect">
                    <option value="months">Months</option>
                    <option value="weeks">Weeks</option>
                  </select>
                </div>
              </div>
            </th>
            <th colspan="3" class="lifetime-group"><div class="lifetime-title">Lifetime</div></th>
          </tr>
          <tr>
            <th class="rank">#</th>
            <th class="sortable" data-field="name">Character <svg class="sort-arrow" viewBox="0 0 10 10" aria-hidden="true"><path d="M5 2 L2 7 H8 Z"/></svg></th>
            <th class="num sortable" data-field="kills">Kills <svg class="sort-arrow" viewBox="0 0 10 10" aria-hidden="true"><path d="M5 2 L2 7 H8 Z"/></svg></th>
            <th class="num sortable" data-field="deaths">Deaths <svg class="sort-arrow" viewBox="0 0 10 10" aria-hidden="true"><path d="M5 2 L2 7 H8 Z"/></svg></th>
            <th class="num sortable" data-field="kd">K/D <svg class="sort-arrow" viewBox="0 0 10 10" aria-hidden="true"><path d="M5 2 L2 7 H8 Z"/></svg></th>
            <th class="num lifetime sortable" data-field="allKills">Kills <svg class="sort-arrow" viewBox="0 0 10 10" aria-hidden="true"><path d="M5 2 L2 7 H8 Z"/></svg></th>
            <th class="num lifetime sortable" data-field="allDeaths">Deaths <svg class="sort-arrow" viewBox="0 0 10 10" aria-hidden="true"><path d="M5 2 L2 7 H8 Z"/></svg></th>
            <th class="num lifetime sortable" data-field="allKd">K/D <svg class="sort-arrow" viewBox="0 0 10 10" aria-hidden="true"><path d="M5 2 L2 7 H8 Z"/></svg></th>
          </tr>
        </thead>
      </table>
      
      <div id="tableBodyWrap" class="table-body-wrap">
        <table class="tbl body">
          <colgroup>
            <col style="width:42px;" />
            <col />
            <col style="width:96px;" />
            <col style="width:96px;" />
            <col style="width:96px;" />
            <col style="width:96px;" />
            <col style="width:96px;" />
            <col style="width:96px;" />
          </colgroup>
          <tbody id="tbody"></tbody>
        </table>
      </div>
      
      <table class="tbl footer">
        <colgroup>
          <col style="width:42px;" />
          <col />
          <col style="width:96px;" />
          <col style="width:96px;" />
          <col style="width:96px;" />
          <col style="width:96px;" />
          <col style="width:96px;" />
          <col style="width:96px;" />
        </colgroup>
        <tfoot>
          <tr>
            <td colspan="5" class="period-footer" style="padding:.55rem .7rem;">
              <div style="display:flex;gap:.5rem;justify-content:center;align-items:center;flex-wrap:wrap;">
                <button type="button" class="mode-btn" data-mode="yearly">Year</button>
                <button type="button" class="mode-btn" data-mode="monthly">Month</button>
                <button type="button" class="mode-btn" data-mode="weekly">Week</button>
                <button type="button" id="currentBtn" class="current-btn" title="Jump to current period">Current</button>
              </div>
            </td>
            <td colspan="3" class="lifetime-footer" style="padding:.55rem .7rem;text-align:right;">
              <span id="status" class="muted"></span>
            </td>
          </tr>
        </tfoot>
      </table>
    </div>
  </div>

  <script>
    (function(){
      const endpoint = 'https://production-api.waremu.com/graphql/';
      const qs = new URLSearchParams(location.search);

  const periodTitle = document.getElementById('periodTitle');
  const status = document.getElementById('status');
      const errorBox = document.getElementById('errorBox');
      const currentBtn = document.getElementById('currentBtn');
      if(!status){ console.warn('Status element not found'); }
  currentBtn?.addEventListener('click', goToCurrent);
      const periodPrevBtn = document.getElementById('periodPrevBtn');
      const periodNextBtn = document.getElementById('periodNextBtn');

      const tbody = document.getElementById('tbody');

  function setBusy(b){ periodPrevBtn.disabled = b; periodNextBtn.disabled = b; status.textContent = b ? 'Loading…' : ''; document.querySelectorAll('.mode-btn').forEach(btn=> btn.disabled = b); }
      function showError(msg){ errorBox.style.display='block'; errorBox.textContent = msg; }
      function clearError(){ errorBox.style.display='none'; errorBox.textContent=''; }

      function getISOWeek(d){
        // Clone date and set to Thursday of current week to get ISO year
        const date = new Date(Date.UTC(d.getUTCFullYear(), d.getUTCMonth(), d.getUTCDate()));
        const dayNum = (date.getUTCDay() + 6) % 7; // Mon=0..Sun=6
        date.setUTCDate(date.getUTCDate() - dayNum + 3); // Thursday
        const firstThursday = new Date(Date.UTC(date.getUTCFullYear(),0,4));
        const diff = (date - firstThursday) / 86400000;
        return 1 + Math.floor(diff / 7);
      }
      function getISOWeekYear(d){
        const date = new Date(Date.UTC(d.getUTCFullYear(), d.getUTCMonth(), d.getUTCDate()));
        const dayNum = (date.getUTCDay() + 6) % 7;
        date.setUTCDate(date.getUTCDate() - dayNum + 3);
        return date.getUTCFullYear();
      }
      // Local-time ISO week (used only for initial display so page opens on user's perceived current week)
      function getISOWeekLocal(d){
        const date = new Date(d.getFullYear(), d.getMonth(), d.getDate());
        const dayNum = (date.getDay() + 6) % 7; // Mon=0..Sun=6
        date.setDate(date.getDate() - dayNum + 3); // Thursday anchor
        const firstThursday = new Date(date.getFullYear(),0,4);
        const firstDayNum = (firstThursday.getDay() + 6) % 7;
        firstThursday.setDate(firstThursday.getDate() - firstDayNum + 3);
        const diff = (date - firstThursday) / 86400000;
        return 1 + Math.floor(diff / 7);
      }
      const careerLabel = (s) => (s || '').replace(/_/g, ' ').toLowerCase().replace(/\b\w/g, (c) => c.toUpperCase());

      async function gql(query, variables){
        const res = await fetch(endpoint, { method: 'POST', headers: { 'content-type': 'application/json' }, body: JSON.stringify({ query, variables }) });
        if(!res.ok){
          let bodyText = await res.text();
          try { const parsed = JSON.parse(bodyText); if(parsed && parsed.errors){ throw new Error(parsed.errors.map(e=>e.message).join('; ')); } } catch {}
          throw new Error('Network error ' + res.status + (bodyText ? ': ' + bodyText.slice(0,200) : ''));
        }
        const json = await res.json();
        if(json.errors){ throw new Error(json.errors.map(e=>e.message).join('; ')); }
        return json.data;
      }

      const WEEKLY_QUERY = `
        query Weekly($year: Int!, $week: Int!){
          weeklyKillLeaderboard(year: $year, week: $week){
            rank
            kills
            deaths
            character { id name career level renownRank }
          }
        }
      `;

      const MONTHLY_QUERY = `
        query Monthly($year: Int!, $month: Int!){
          monthlyKillLeaderboard(year: $year, month: $month){
            rank
            kills
            deaths
            character { id name career level renownRank }
          }
        }
      `;

  function kdOf(row){ return row.deaths > 0 ? (row.kills / row.deaths) : row.kills; }

      function renderRows(rows){
        tbody.innerHTML = '';
        rows.forEach(r => {
          const tr = document.createElement('tr');
          if(r.character?.id) tr.setAttribute('data-id', r.character.id);
          tr.innerHTML = `
            <td class="rank">${r.rank}</td>
            <td>
              <span class="char-cell">
                ${r.character?.career ? `<img class="career-icon" loading="lazy" src="https://killboard.returnofreckoning.com/images/icons/${r.character.career.toLowerCase().replace(/_/g,'-')}.png" alt="${careerLabel(r.character.career)}" onerror="this.onerror=null;this.src='/icons/careers/${r.character.career.toLowerCase().replace(/_/g,'-')}.png';" />` : ''}
                <span>${r.character?.name || 'Unknown'}</span>
                ${r.character?.level != null || r.character?.renownRank != null ? `<span class="char-meta">${r.character?.level != null ? 'Lvl <span class="num-val">'+r.character.level+'</span>' : ''}${(r.character?.level != null && r.character?.renownRank != null) ? ', ' : ''}${r.character?.renownRank != null ? 'RR <span class="num-val">'+r.character.renownRank+'</span>' : ''}</span>` : ''}
              </span>
            </td>
            <td class="num">${r.kills}</td>
            <td class="num">${r.deaths}</td>
            <td class="num">${kdOf(r).toFixed(2)}</td>
            <td class="num lifetime all-kills">…</td>
            <td class="num lifetime all-deaths">…</td>
            <td class="num lifetime all-kd">…</td>
          `;
          tbody.appendChild(tr);
        });
        // Adjust scroll behavior based on row count and view
        adjustScrolling();
        // Keep header/body/footer column widths in sync
        syncColumnWidths();
      }

      function sortRows(baseRows){
        const rows = baseRows.slice();
        const dir = sortDir === 'asc' ? 1 : -1;
        const getLifetime = (r)=> lifetimeCache.get(r.character?.id || '') || { kills:0, deaths:0, kd:0 };
        rows.sort((a,b)=>{
          if(sortField === 'name'){
            const an = (a.character?.name || '').toLowerCase();
            const bn = (b.character?.name || '').toLowerCase();
            const ndir = (sortDir === 'desc') ? 1 : -1;
            if(an !== bn){
              return (an < bn ? -1 : 1) * ndir;
            }
            const killDiff = b.kills - a.kills;
            if(killDiff !== 0) return killDiff;
            return a.deaths - b.deaths;
          }
          if(sortField === 'kills'){
            if(sortDir === 'desc'){
              if(b.kills !== a.kills) return b.kills - a.kills;
              return a.deaths - b.deaths;
            } else {
              if(a.kills !== b.kills) return a.kills - b.kills;
              return a.deaths - b.deaths;
            }
          }
          let av,bv;
          if(sortField === 'deaths'){ av=a.deaths; bv=b.deaths; }
          else if(sortField === 'kd'){ av= kdOf(a); bv= kdOf(b); }
          else if(sortField === 'allKills'){ av=getLifetime(a).kills; bv=getLifetime(b).kills; }
          else if(sortField === 'allDeaths'){ av=getLifetime(a).deaths; bv=getLifetime(b).deaths; }
          else if(sortField === 'allKd'){ av=getLifetime(a).kd; bv=getLifetime(b).kd; }
          else { av=0; bv=0; }
          if(av === bv){
            const killDiff = b.kills - a.kills;
            if(killDiff !== 0) return killDiff;
            return a.deaths - b.deaths;
          }
            return (av > bv ? 1 : -1) * dir;
        });
        return rows;
      }

  let yearlyAllRows = [];
      async function fetchAndRender(ev){
        ev?.preventDefault();
        clearError(); setBusy(true);
        const period = currentPeriod;
        const year = period==='weekly' ? weeklyYear : period==='monthly' ? monthlyYear : yearlyYear;
        try{
          let data, rows;
          if(period === 'weekly'){
            const week = weeklyWeek;
            if(!(week >= 1 && week <= 53)) { showError('Invalid ISO week (1-53).'); return; }
            data = await gql(WEEKLY_QUERY, { year, week });
            rows = data?.weeklyKillLeaderboard || [];
          } else if(period === 'monthly') {
            const month = monthlyMonth;
            if(!(month >= 1 && month <= 12)) { showError('Invalid month (1-12).'); return; }
            data = await gql(MONTHLY_QUERY, { year, month });
            rows = data?.monthlyKillLeaderboard || [];
          } else {
            
            const now = new Date();
            const currentISOYear = getISOWeekYear(now);
            const aggregate = new Map();
            
            if(yearlyAggregation === 'weeks'){
              const lastWeek = (year === currentISOYear) ? getISOWeek(now) : isoWeeksInYear(year);
              for(let w=1; w<=lastWeek; w++){
                status.textContent = `Loading… (week ${w}/${lastWeek})`;
                try {
                  const d = await gql(WEEKLY_QUERY, { year, week: w });
                  const list = d?.weeklyKillLeaderboard || [];
                  for(const entry of list){
                    const id = entry.character?.id; if(!id) continue;
                    const prev = aggregate.get(id) || { character: entry.character, kills: 0, deaths: 0 };
                    prev.kills += entry.kills;
                    prev.deaths += entry.deaths;
                    aggregate.set(id, prev);
                  }
                } catch(e){ console.warn('Failed week', w, e); }
              }
            } else {
              const currentYearUTC = now.getUTCFullYear();
              const lastMonth = (year === currentYearUTC) ? (now.getUTCMonth() + 1) : 12;
              for(let m=1; m<=lastMonth; m++){
                status.textContent = `Loading… (month ${m}/${lastMonth})`;
                try {
                  const d = await gql(MONTHLY_QUERY, { year, month: m });
                  const list = d?.monthlyKillLeaderboard || [];
                  for(const entry of list){
                    const id = entry.character?.id; if(!id) continue;
                    const prev = aggregate.get(id) || { character: entry.character, kills: 0, deaths: 0 };
                    prev.kills += entry.kills;
                    prev.deaths += entry.deaths;
                    aggregate.set(id, prev);
                  }
                } catch(e){ console.warn('Failed month', m, e); }
              }
            }
            yearlyAllRows = Array.from(aggregate.values()).map(v => ({ rank: 0, kills: v.kills, deaths: v.deaths, character: v.character }));
            rows = yearlyAllRows.slice();
          }
          
          let displayRows;
          if(period === 'yearly'){
            const fullySorted = sortRows(yearlyAllRows);
            fullySorted.forEach((r,i)=> r.rank = i+1);
            displayRows = fullySorted;
          } else {
            const sorted = sortRows(rows);
            sorted.forEach((r,i)=> r.rank = i+1);
            displayRows = sorted;
          }
          currentRows = displayRows.slice();
          renderRows(displayRows);
          
          augmentWithLifetimeTotals(displayRows);
          
          updateUrl();
          updatePeriodTitle();
        }catch(e){
          showError(String(e.message || e));
        }finally{ setBusy(false); }
      }

      

  const lifetimeCache = new Map();
  let lifetimeGeneration = 0;
      let currentRows = [];
      async function augmentWithLifetimeTotals(rows){
  const gen = ++lifetimeGeneration;
        const ids = rows.map(r => r.character?.id).filter(Boolean);
        const pending = ids.filter(id => !lifetimeCache.has(id));
        if(pending.length === 0){ populateLifetimeCells(); return; }
        status.textContent = 'Fetching lifetime totals…';
        const chunkSize = 15;
        for(let i=0;i<pending.length;i+=chunkSize){
          
          if(gen !== lifetimeGeneration){ return; }
          const chunk = pending.slice(i,i+chunkSize);
          const varDefs = chunk.map((_,j)=> `$v${i+j}: UnsignedInt!`).join(' ');
          const bodyParts = chunk.map((_,j)=> `a${i+j}Kills: kills(first:1, where:{ killerCharacterId:{ eq:$v${i+j} } }){ totalCount } a${i+j}Deaths: kills(first:1, where:{ victimCharacterId:{ eq:$v${i+j} } }){ totalCount }`).join(' ');
          const query = `query Lifetime(${varDefs}){ ${bodyParts} }`;
          const vars = {}; chunk.forEach((id,j)=> { vars[`v${i+j}`] = Number(id); });
          let data;
          try { data = await gql(query, vars); }
          catch(e){ console.warn('Lifetime batch failed', e); continue; }
          
          if(gen !== lifetimeGeneration){ return; }
          chunk.forEach((id,j)=> {
            const killsField = `a${i+j}Kills`;
            const deathsField = `a${i+j}Deaths`;
            const kills = data?.[killsField]?.totalCount ?? 0;
            const deaths = data?.[deathsField]?.totalCount ?? 0;
            lifetimeCache.set(id, { kills, deaths, kd: deaths > 0 ? kills / deaths : kills });
          });
          status.textContent = `Fetching lifetime totals… (${Math.min(i+chunkSize, pending.length)}/${pending.length})`;
        }
        
        if(gen === lifetimeGeneration){
          populateLifetimeCells();
          status.textContent = '';
          
          if(sortField === 'allKills' || sortField === 'allDeaths' || sortField === 'allKd'){
            resortWithCurrentSort();
          }
        }
      }

      function populateLifetimeCells(){
        
        Array.from(tbody.querySelectorAll('tr')).forEach(tr => {
          const id = tr.getAttribute('data-id');
          if(!id) return;
          const stats = lifetimeCache.get(id);
          if(!stats) return;
          const allKillsCell = tr.querySelector('.all-kills');
          const allDeathsCell = tr.querySelector('.all-deaths');
          const allKDCell = tr.querySelector('.all-kd');
          if(allKillsCell) allKillsCell.textContent = stats.kills.toString();
          if(allDeathsCell) allDeathsCell.textContent = stats.deaths.toString();
          if(allKDCell) allKDCell.textContent = stats.kd.toFixed(2);
        });
      }

  let currentPeriod = 'weekly';
  let sortField = 'kills';
  let sortDir = 'desc';
  const qsSort = qs.get('sort');
  const qsDir = qs.get('dir');
  const allowedSortFields = ['name','kills','deaths','kd','allKills','allDeaths','allKd'];
  if(qsSort && allowedSortFields.includes(qsSort)) sortField = qsSort;
  if(qsDir && (qsDir === 'asc' || qsDir === 'desc')) sortDir = qsDir;
  requestAnimationFrame(()=>{
    const th = document.querySelector(`th.sortable[data-field="${sortField}"]`);
    if(th) th.classList.add('active', sortDir);
  });
      const now = new Date();
      const defPeriod = qs.get('period') || 'weekly';
      currentPeriod = defPeriod;
      // Maintain independent selections per view
      let weeklyYear = Number(qs.get('year')) || getISOWeekYear(now);
      let weeklyWeek = Number(qs.get('week')) || getISOWeekLocal(now);
      let monthlyYear = Number(qs.get('year')) || now.getUTCFullYear();
      let monthlyMonth = Number(qs.get('month')) || (now.getUTCMonth()+1);
      let yearlyYear = Number(qs.get('year')) || now.getUTCFullYear();
      let yearlyAggregation = (qs.get('yagg') === 'weeks') ? 'weeks' : 'months'; // 'months' | 'weeks'
      const aggSelect = document.getElementById('aggSelect');
      const aggControl = document.getElementById('aggControl');
      if(aggSelect){ aggSelect.value = yearlyAggregation; }
      function updateAggControlVisibility(){
        if(!aggControl) return;
        aggControl.style.display = (currentPeriod === 'yearly') ? 'flex' : 'none';
      }
      aggSelect?.addEventListener('change', ()=>{
        const val = aggSelect.value === 'weeks' ? 'weeks' : 'months';
        if(val !== yearlyAggregation){
          yearlyAggregation = val;
          updateUrl();
          fetchAndRender();
        }
      });
      function updatePeriodTitle(){
        if(currentPeriod === 'yearly') periodTitle.textContent = `Year ${yearlyYear}`;
        else if(currentPeriod === 'monthly') {
          const date = new Date(Date.UTC(monthlyYear, monthlyMonth-1, 1));
          const monthName = date.toLocaleString(undefined, { month:'long' });
          periodTitle.textContent = `${monthName} ${monthlyYear}`;
        } else {
          periodTitle.textContent = `Week ${weeklyWeek}, ${weeklyYear}`;
        }
        updateCurrentButtonState();
        updateAggControlVisibility();
      }
      function updateCurrentButtonState(){
        const now = new Date();
        let isCurrent = false;
        if(currentPeriod === 'weekly'){
          const curW = getISOWeekLocal(now);
          const curY = getISOWeekYear(now);
          isCurrent = (weeklyWeek === curW) && (weeklyYear === curY);
        } else if(currentPeriod === 'monthly'){
          isCurrent = (monthlyYear === now.getUTCFullYear()) && (monthlyMonth === (now.getUTCMonth()+1));
        } else if(currentPeriod === 'yearly'){
          isCurrent = (yearlyYear === now.getUTCFullYear());
        }
        const btn = document.getElementById('currentBtn');
        if(btn){ btn.classList.toggle('active', !!isCurrent); }
      }
      function setMode(mode){
        if(mode === currentPeriod) return;
        currentPeriod = mode;
        document.querySelectorAll('.mode-btn').forEach(b => b.classList.toggle('active', b.dataset.mode === mode));
        updatePeriodTitle();
        fetchAndRender();
      }
      function goToCurrent(){
        const now = new Date();
        if(currentPeriod === 'weekly'){
          weeklyWeek = getISOWeekLocal(now);
          weeklyYear = getISOWeekYear(now);
        } else if(currentPeriod === 'monthly') {
          monthlyYear = now.getUTCFullYear();
          monthlyMonth = now.getUTCMonth() + 1;
        } else if(currentPeriod === 'yearly') {
          yearlyYear = now.getUTCFullYear();
        }
        updatePeriodTitle();
        fetchAndRender();
      }
      document.querySelectorAll('.mode-btn').forEach(btn => btn.addEventListener('click', () => setMode(btn.dataset.mode)));
      document.querySelectorAll('.mode-btn').forEach(b => b.classList.toggle('active', b.dataset.mode === currentPeriod));
      updatePeriodTitle();
    updateCurrentButtonState();
  // Initial fetch (single)
  fetchAndRender();

      function weekStartDate(year, week){
        const jan4 = new Date(Date.UTC(year,0,4));
        const dayOfWeek = (jan4.getUTCDay() + 6) % 7;
        const mondayWeek1 = new Date(jan4);
        mondayWeek1.setUTCDate(jan4.getUTCDate() - dayOfWeek);
        const d = new Date(mondayWeek1);
        d.setUTCDate(mondayWeek1.getUTCDate() + (week-1)*7);
        return d;
      }
      function adjustWeek(delta){
        const maxWeeksCurrentYear = isoWeeksInYear(weeklyYear);
        weeklyWeek += delta;
        if(weeklyWeek < 1){
          weeklyYear -= 1;
          if(weeklyYear < 2008) weeklyYear = 2008;
          weeklyWeek = isoWeeksInYear(weeklyYear);
        } else if(weeklyWeek > maxWeeksCurrentYear){
          weeklyYear += 1;
          if(weeklyYear > 2100) weeklyYear = 2100;
          weeklyWeek = 1;
        }
        updatePeriodTitle();
        fetchAndRender();
      }
      function isoWeeksInYear(y){
        const dec28 = new Date(Date.UTC(y,11,28));
        return getISOWeek(dec28);
      }
      function adjustMonth(delta){
        monthlyMonth += delta;
        if(monthlyMonth < 1){ monthlyMonth = 12; monthlyYear -= 1; }
        else if(monthlyMonth > 12){ monthlyMonth = 1; monthlyYear += 1; }
        updatePeriodTitle();
        fetchAndRender();
      }
      function adjustYear(delta){
        yearlyYear += delta;
        if(yearlyYear < 2008) yearlyYear = 2008; if(yearlyYear > 2100) yearlyYear = 2100;
        updatePeriodTitle();
        fetchAndRender();
      }
      periodPrevBtn.addEventListener('click', () => {
        if(currentPeriod === 'weekly') adjustWeek(-1);
        else if(currentPeriod === 'monthly') adjustMonth(-1);
        else adjustYear(-1);
      });
      periodNextBtn.addEventListener('click', () => {
        if(currentPeriod === 'weekly') adjustWeek(1);
        else if(currentPeriod === 'monthly') adjustMonth(1);
        else adjustYear(1);
      });
      function applySort(field){
        if(sortField === field){
          sortDir = sortDir === 'desc' ? 'asc' : 'desc';
        } else {
          sortField = field;
          sortDir = 'desc';
        }
        updateSortHeaderState();
        updateUrl();
        if(currentPeriod === 'yearly'){
          const fullySorted = sortRows(yearlyAllRows);
          fullySorted.forEach((r,i)=> r.rank = i+1);
          currentRows = fullySorted.slice();
          renderRows(fullySorted);
          adjustScrolling();
          syncColumnWidths();
          augmentWithLifetimeTotals(fullySorted);
        } else {
          const base = currentRows.map(r=> r);
          const resorted = sortRows(base);
          resorted.forEach((r,i)=> r.rank = i+1);
          currentRows = resorted.slice();
          renderRows(resorted);
          adjustScrolling();
          syncColumnWidths();
          augmentWithLifetimeTotals(resorted);
        }
      }
      function updateSortHeaderState(){
        document.querySelectorAll('th.sortable').forEach(th => {
          const f = th.getAttribute('data-field');
          th.classList.toggle('active', f === sortField);
          th.classList.toggle('asc', f === sortField && sortDir === 'asc');
          th.classList.toggle('desc', f === sortField && sortDir === 'desc');
        });
      }
      function resortWithCurrentSort(){
        if(currentPeriod === 'yearly'){
          const fullySorted = sortRows(yearlyAllRows);
          fullySorted.forEach((r,i)=> r.rank = i+1);
          currentRows = fullySorted.slice();
          renderRows(fullySorted);
          // lifetime values are cached; repopulate cells in the new order
          populateLifetimeCells();
          adjustScrolling();
          syncColumnWidths();
        } else {
          const base = currentRows.map(r=> r);
          const resorted = sortRows(base);
          resorted.forEach((r,i)=> r.rank = i+1);
          currentRows = resorted.slice();
          renderRows(resorted);
          populateLifetimeCells();
          adjustScrolling();
          syncColumnWidths();
        }
      }
      function syncColumnWidths(){
        const headerTable = document.querySelector('.tbl.header');
        const bodyTable = document.querySelector('.tbl.body');
        const footerTable = document.querySelector('.tbl.footer');
        if(!headerTable) return;
        const ths = headerTable.querySelectorAll('thead tr:nth-child(2) th');
        if(ths.length !== 8) return;
        const widths = Array.from(ths).map(th => Math.ceil(th.getBoundingClientRect().width));
        [headerTable, bodyTable, footerTable].forEach(tbl => {
          if(!tbl) return;
          const cols = tbl.querySelectorAll('colgroup col');
          cols.forEach((col, i) => { if(widths[i]) col.style.width = widths[i] + 'px'; });
        });
      }
      // keep alignment on viewport changes
      let __resizeSyncTimer;
      window.addEventListener('resize', ()=>{
        if(__resizeSyncTimer) clearTimeout(__resizeSyncTimer);
        __resizeSyncTimer = setTimeout(()=>{ syncColumnWidths(); }, 100);
      });
      function adjustScrolling(){
        const bodyWrap = document.getElementById('tableBodyWrap');
        if(!bodyWrap) return;
        const rowCount = tbody?.rows?.length || 0;
        if(currentPeriod === 'yearly' && rowCount > 20){
          const firstRow = tbody.querySelector('tr');
          if(!firstRow){ bodyWrap.style.maxHeight=''; return; }
          const rowH = firstRow.getBoundingClientRect().height || 28;
          const maxVisibleRows = 20;
          const bodyMax = Math.ceil(rowH * maxVisibleRows);
          bodyWrap.style.maxHeight = bodyMax + 'px';
        } else {
          bodyWrap.style.maxHeight = '';
        }
      }
      function updateUrl(){
        const u = new URL(location.href);
        u.searchParams.set('period', currentPeriod);
        if(currentPeriod==='weekly'){
          u.searchParams.set('year', String(weeklyYear));
          u.searchParams.set('week', String(weeklyWeek));
          u.searchParams.delete('month');
          u.searchParams.delete('yagg');
        } else if(currentPeriod==='monthly'){
          u.searchParams.set('year', String(monthlyYear));
          u.searchParams.set('month', String(monthlyMonth));
          u.searchParams.delete('week');
          u.searchParams.delete('yagg');
        } else {
          u.searchParams.set('year', String(yearlyYear));
          u.searchParams.delete('week');
          u.searchParams.delete('month');
          u.searchParams.set('yagg', yearlyAggregation);
        }
        if(sortField) u.searchParams.set('sort', sortField); else u.searchParams.delete('sort');
        if(sortDir) u.searchParams.set('dir', sortDir); else u.searchParams.delete('dir');
        history.replaceState(null, '', u);
      }
      document.querySelectorAll('th.sortable').forEach(th => th.addEventListener('click', () => applySort(th.getAttribute('data-field'))));
      updateUrl();
    })();
  </script>
</body>
</html>
