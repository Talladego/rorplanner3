<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Character Ratings | RoR Planner</title>
  <style>
    :root { color-scheme: light dark; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji"; margin: 0; padding: 2rem; line-height: 1.4; }
    .container { max-width: 980px; margin: 0 auto; }
    h1 { margin: 0 0 1rem; font-size: 1.6rem; }
    form { display: flex; gap: .5rem; flex-wrap: wrap; margin-bottom: 1rem; }
    input[type="text"] { flex: 1 1 280px; padding: .6rem .7rem; font-size: 1rem; border-radius: .5rem; border: 1px solid #9999; }
    button { padding: .6rem 1rem; font-size: 1rem; border-radius: .5rem; border: 1px solid #5558; background: #2563eb; color: white; cursor: pointer; }
    button:disabled { opacity: .6; cursor: default; }
    .muted { opacity: .8; font-size: .95rem; }
    .error { color: #b00020; margin: .5rem 0 0; }
    .grid { display: grid; gap: .75rem; grid-template-columns: 1fr; }
    table { width: 100%; border-collapse: collapse; border: 1px solid #9994; border-radius: .5rem; overflow: hidden; }
    thead { background: #f4f4f8; color: #111; }
    :root[data-theme="dark"] thead { background: #1f2937; color: #e5e7eb; }
    th, td { padding: .6rem .7rem; border-bottom: 1px solid #9993; text-align: left; font-variant-numeric: tabular-nums; }
    th { font-weight: 600; }
    tbody tr:hover { background: #00000008; }
    .chip { display: inline-block; font-size: .85rem; padding: .15rem .5rem; border-radius: 999px; border: 1px solid #9995; }
    .small { font-size: .9rem; }
    .row { display: flex; gap: .75rem; align-items: center; flex-wrap: wrap; }
    .spacer { flex: 1; }
    .alt-list { margin-top: .5rem; }
    code.k { padding: .1rem .3rem; border: 1px solid #9995; border-radius: .35rem; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size: .85rem; }
  /* Bottom-right fetching/loading status */
  #status { position: fixed; bottom: 10px; right: 14px; font-size:.8rem; background:rgba(0,0,0,.55); color:#fff; padding:.35rem .55rem; border-radius:.4rem; z-index:100; }
  :root[data-theme="light"] #status { background:rgba(0,0,0,.55); }
  :root[data-theme="dark"] #status { background:rgba(0,0,0,.55); }
  </style>
</head>
<body>
  <div class="container">
    <h1>Character Ratings</h1>
    <form id="searchForm">
      <input id="nameInput" type="text" name="name" placeholder="Character name (exact)" required />
      <input id="fromInput" type="date" required />
      <input id="toInput" type="date" required />
      <label class="small" style="display:inline-flex;align-items:center;gap:.4rem;">
        <input id="allInput" type="checkbox" /> All time
      </label>
      <button id="submitBtn" type="submit">Search</button>
      <span id="status" class="muted"></span>
    </form>

    <div class="grid">
      <div id="characterHeader" class="row muted" style="display:none">
        <div id="charSummary"></div>
        <div class="spacer"></div>
        <div id="altMatches" class="small"></div>
      </div>

      <div id="errorBox" class="error" style="display:none"></div>

      <div id="kdWrap" style="display:none;grid-template-columns:repeat(2,minmax(0,1fr));align-items:start" class="grid" >
        <div id="summary" class="small" style="border:1px solid #9994;border-radius:.5rem;padding:.5rem .7rem;">
          <strong>Summary:</strong>
          <span id="sumKills" class="chip">Kills: 0</span>
          <span id="sumDeaths" class="chip">Deaths: 0</span>
          <span id="sumKD" class="chip">K/D: 0.00</span>
        </div>
        <div>
          <h3 style="margin:.5rem 0">Recent Kills</h3>
          <table>
            <thead>
              <tr>
                <th>Time</th>
                <th>Victim</th>
                <th>Context</th>
              </tr>
            </thead>
            <tbody id="killsBody"></tbody>
          </table>
        </div>
        <div>
          <h3 style="margin:.5rem 0">Recent Deaths</h3>
          <table>
            <thead>
              <tr>
                <th>Time</th>
                <th>Killer</th>
                <th>Context</th>
              </tr>
            </thead>
            <tbody id="deathsBody"></tbody>
          </table>
        </div>
        <div>
          <h3 style="margin:.5rem 0">Top Victims</h3>
          <table>
            <thead>
              <tr>
                <th>Victim</th>
                <th>Count</th>
              </tr>
            </thead>
            <tbody id="topVictimsBody"></tbody>
          </table>
        </div>
        <div>
          <h3 style="margin:.5rem 0">Top Killers</h3>
          <table>
            <thead>
              <tr>
                <th>Killer</th>
                <th>Count</th>
              </tr>
            </thead>
            <tbody id="topKillersBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
  <script>
    (function(){
      const endpoint = 'https://production-api.waremu.com/graphql/';

      const qs = new URLSearchParams(location.search);
      const nameInput = document.getElementById('nameInput');
      const form = document.getElementById('searchForm');
      const status = document.getElementById('status');
      const errorBox = document.getElementById('errorBox');
  const kdWrap = document.getElementById('kdWrap');
  const killsBody = document.getElementById('killsBody');
  const deathsBody = document.getElementById('deathsBody');
  const topVictimsBody = document.getElementById('topVictimsBody');
  const topKillersBody = document.getElementById('topKillersBody');
      const header = document.getElementById('characterHeader');
      const charSummary = document.getElementById('charSummary');
      const altMatches = document.getElementById('altMatches');
    const submitBtn = document.getElementById('submitBtn');
  const fromInput = document.getElementById('fromInput');
  const toInput = document.getElementById('toInput');
  const allInput = document.getElementById('allInput');
  const sumKills = document.getElementById('sumKills');
  const sumDeaths = document.getElementById('sumDeaths');
  const sumKD = document.getElementById('sumKD');

      const rTypeLabel = (t) => ({
        CASUAL: 'Casual',
        RANKED_SOLO: 'Ranked (Solo)',
        RANKED_GROUP: 'Ranked (Group)',
        CITY: 'City'
      }[t] || t);
      const careerLabel = (s) => (s || '').replace(/_/g, ' ').toLowerCase().replace(/\b\w/g, (c) => c.toUpperCase());

      function setBusy(b){ submitBtn.disabled = b; nameInput.disabled = b; status.textContent = b ? 'Loading…' : ''; }
      function showError(msg){ errorBox.style.display='block'; errorBox.textContent = msg; }
      function clearError(){ errorBox.style.display='none'; errorBox.textContent=''; }
  function toUTCSeconds(d){ return Math.floor(d.getTime() / 1000); }
  function fmtDate(ts){ const d = new Date(ts*1000); return d.toLocaleString(); }

      async function gql(query, variables){
        const res = await fetch(endpoint, {
          method: 'POST',
          headers: { 'content-type': 'application/json' },
          body: JSON.stringify({ query, variables })
        });
        if(!res.ok){
          // Try to parse GraphQL errors for better visibility
          let bodyText = await res.text();
          try {
            const parsed = JSON.parse(bodyText);
            if(parsed && parsed.errors){
              throw new Error(parsed.errors.map(e=>e.message).join('; '));
            }
          } catch { /* ignore parse error */ }
          throw new Error('Network error ' + res.status + (bodyText ? ': ' + bodyText.slice(0,200) : ''));
        }
        const json = await res.json();
        if(json.errors){ throw new Error(json.errors.map(e=>e.message).join('; ')); }
        return json.data;
      }

      const QUERY = `
        query GetCharacterByName($name: String!, $first: Int = 5) {
          characters(first: $first, where: { name: { eq: $name } }) {
            nodes {
              id
              name
              level
              renownRank
              career
            }
          }
        }
      `;

      const KILLS_QUERY_RANGED = `
        query GetRecentKillsAndDeaths($characterId: UnsignedInt!, $from: Int!, $to: Int!, $first: Int = 20) {
          killsRecent: kills(first: $first, where: { time: { gte: $from, lte: $to }, killerCharacterId: { eq: $characterId } }) {
            totalCount
            nodes {
              id
              time
              scenario { name }
              instance { scenario { name } }
              victim { level renownRank character { id name career } }
              deathblow { id name }
            }
          }
          deathsRecent: kills(first: $first, where: { time: { gte: $from, lte: $to }, victimCharacterId: { eq: $characterId } }) {
            totalCount
            nodes {
              id
              time
              scenario { name }
              instance { scenario { name } }
              deathblow { id name career }
            }
          }
        }
      `;

      const KILLS_QUERY_ALL = `
        query GetRecentKillsAndDeathsAll($characterId: UnsignedInt!, $first: Int = 20) {
          killsRecent: kills(first: $first, where: { killerCharacterId: { eq: $characterId } }) {
            totalCount
            nodes {
              id
              time
              scenario { name }
              instance { scenario { name } }
              victim { level renownRank character { id name career } }
              deathblow { id name }
            }
          }
          deathsRecent: kills(first: $first, where: { victimCharacterId: { eq: $characterId } }) {
            totalCount
            nodes {
              id
              time
              scenario { name }
              instance { scenario { name } }
              deathblow { id name career }
            }
          }
        }
      `;

      function renderRatingsSummary(alternatives, picked){
        // Header
        header.style.display = 'flex';
        const c = picked;
  charSummary.textContent = `${c.name} — L${c.level} RR${c.renownRank} · ${careerLabel(c.career)}`;

        // Alternatives
        if(alternatives.length > 1){
          altMatches.innerHTML = 'Other matches: ' + alternatives.filter(x => x.id !== c.id)
            .map(x => `<span class=\"chip\" title=\"L${x.level} RR${x.renownRank}\">${x.name} · ${careerLabel(x.career)}</span>`)
            .join(' ');
        } else {
          altMatches.textContent = '';
        }

        // We no longer show ratings table by default; K/D tables render separately.
      }

      async function onSubmit(ev){
        ev?.preventDefault();
        clearError();
        const name = nameInput.value.trim();
        if(!name){ showError('Please enter a character name.'); return; }
        // read dates or handle all-time
        let fromDate = null, toDate = null;
        const all = !!allInput.checked;
        if(!all){
          try{
            fromDate = new Date(fromInput.value);
            toDate = new Date(toInput.value);
            if(!(fromDate instanceof Date) || isNaN(fromDate) || !(toDate instanceof Date) || isNaN(toDate)){
              showError('Please pick a valid From/To date or check All time.'); return;
            }
            // include entire end day by adding 23:59:59
            toDate.setHours(23,59,59,999);
          }catch(_e){ showError('Please pick a valid From/To date or check All time.'); return; }
        }
        setBusy(true);
        try{
          const data = await gql(QUERY, { name, first: 5 });
          const nodes = data?.characters?.nodes || [];
          if(nodes.length === 0){ showError('No character found with that exact name.'); kdWrap.style.display='none'; header.style.display='none'; return; }
          const picked = nodes[0];
          renderRatingsSummary(nodes, picked);
          // Fetch recent kills/deaths within range or all-time
          const numericId = Number(picked.id);
          if(!Number.isFinite(numericId)) { throw new Error('Character id is not numeric; cannot query kills.'); }
          // Fetch with safe pagination and automatic fallback if server limit is exceeded
          async function fetchKDWithFallback(){
            const sizes = [50, 25, 10];
            let lastErr = null;
            for(const size of sizes){
              try{
                if(all){
                  return await gql(KILLS_QUERY_ALL, { characterId: numericId, first: size });
                } else {
                  const from = toUTCSeconds(fromDate);
                  const to = toUTCSeconds(toDate);
                  return await gql(KILLS_QUERY_RANGED, { characterId: numericId, from, to, first: size });
                }
              }catch(e){
                const msg = String(e && (e.message || e)).toLowerCase();
                if(msg.includes('maximum allowed items per page')){ lastErr = e; continue; }
                throw e; // other errors propagate
              }
            }
            throw lastErr || new Error('Unable to fetch kills/deaths with permitted page size.');
          }
          const kd = await fetchKDWithFallback();
          const kills = kd?.killsRecent?.nodes || [];
          const deaths = kd?.deathsRecent?.nodes || [];
          const killsTotal = kd?.killsRecent?.totalCount ?? kills.length;
          const deathsTotal = kd?.deathsRecent?.totalCount ?? deaths.length;
          const kdRatio = deathsTotal > 0 ? (killsTotal / deathsTotal) : killsTotal;
          // Render tables
          killsBody.innerHTML = '';
          deathsBody.innerHTML = '';
          topVictimsBody.innerHTML = '';
          topKillersBody.innerHTML = '';
          const ctx = (k) => (k?.instance?.scenario?.name || k?.scenario?.name || 'Open World');
          // Sort by time desc just in case
          kills.sort((a,b)=> b.time - a.time).slice(0,20).forEach(k => {
            const v = k.victim?.character;
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${fmtDate(k.time)}</td>
              <td>${v ? `${v.name} · ${careerLabel(v.career)}` : 'Unknown'}</td>
              <td>${ctx(k)}</td>
            `;
            killsBody.appendChild(tr);
          });
          deaths.sort((a,b)=> b.time - a.time).slice(0,20).forEach(k => {
            const killer = k.deathblow;
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${fmtDate(k.time)}</td>
              <td>${killer ? `${killer.name}${killer.career ? ' · ' + careerLabel(killer.career) : ''}` : 'Unknown'}</td>
              <td>${ctx(k)}</td>
            `;
            deathsBody.appendChild(tr);
          });
          // Compute Top Victims
          const victimCounts = new Map();
          for(const k of kills){
            const vc = k?.victim?.character; if(!vc) continue;
            const key = vc.id;
            const cur = victimCounts.get(key) || { id: vc.id, name: vc.name, career: vc.career, count: 0 };
            cur.count += 1; victimCounts.set(key, cur);
          }
          const topVictims = Array.from(victimCounts.values()).sort((a,b)=> b.count - a.count).slice(0,10);
          topVictims.forEach(v => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${v.name} · ${careerLabel(v.career)}</td>
              <td>${v.count}</td>
            `;
            topVictimsBody.appendChild(tr);
          });
          // Compute Top Killers
          const killerCounts = new Map();
          for(const k of deaths){
            const kb = k?.deathblow; if(!kb) continue;
            const key = kb.id;
            const cur = killerCounts.get(key) || { id: kb.id, name: kb.name, career: kb.career, count: 0 };
            cur.count += 1; killerCounts.set(key, cur);
          }
          const topKillers = Array.from(killerCounts.values()).sort((a,b)=> b.count - a.count).slice(0,10);
          topKillers.forEach(x => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${x.name}${x.career ? ' · ' + careerLabel(x.career) : ''}</td>
              <td>${x.count}</td>
            `;
            topKillersBody.appendChild(tr);
          });
          // summary
          sumKills.textContent = `Kills: ${killsTotal}`;
          sumDeaths.textContent = `Deaths: ${deathsTotal}`;
          sumKD.textContent = `K/D: ${kdRatio.toFixed(2)}`;
          kdWrap.style.display = (kills.length + deaths.length) ? 'block' : 'none';
          // push state for sharing
          const u = new URL(location.href);
          u.searchParams.set('name', name);
          if(all){
            u.searchParams.set('all', '1');
            u.searchParams.delete('from');
            u.searchParams.delete('to');
          } else {
            u.searchParams.delete('all');
            u.searchParams.set('from', fromInput.value);
            u.searchParams.set('to', toInput.value);
          }
          history.replaceState(null, '', u);
        }catch(e){
          showError(String(e.message || e));
        }finally{ setBusy(false); }
      }

      form.addEventListener('submit', onSubmit);
      // Initialize date inputs to last 7 days
      const today = new Date();
      const start = new Date(Date.UTC(today.getUTCFullYear(), today.getUTCMonth(), today.getUTCDate()));
      const end = new Date(start); end.setUTCDate(end.getUTCDate());
      const start7 = new Date(start); start7.setUTCDate(start7.getUTCDate() - 7);
      const pad = (n) => String(n).padStart(2,'0');
      const toYMD = (d) => `${d.getUTCFullYear()}-${pad(d.getUTCMonth()+1)}-${pad(d.getUTCDate())}`;
      const isAll = qs.get('all') === '1';
      fromInput.value = qs.get('from') || toYMD(start7);
      toInput.value = qs.get('to') || toYMD(end);
      allInput.checked = isAll;
      fromInput.disabled = isAll; toInput.disabled = isAll;
      allInput.addEventListener('change', () => {
        const a = allInput.checked;
        fromInput.disabled = a; toInput.disabled = a;
      });
      const initial = qs.get('name');
      if(initial){ nameInput.value = initial; onSubmit(); }
    })();
  </script>
</body>
</html>
